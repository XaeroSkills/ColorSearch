"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,n){return new(t||(t=Promise))(function(a,d){function s(e){try{u(n.next(e))}catch(e){d(e)}}function l(e){try{u(n.throw(e))}catch(e){d(e)}}function u(e){e.done?a(e.value):new t(function(i){i(e.value)}).then(s,l)}u((n=n.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const Settings_1=require("../core/Settings"),IndexDAO_1=require("./dao/IndexDAO"),EuclideanHashFamily_1=require("./lsh/families/EuclideanHashFamily"),S2JSDHashFamily_1=require("./lsh/families/S2JSDHashFamily"),LSH_1=require("./lsh/LSH"),Vector_1=require("./Vector"),Debug=require("debug"),debug=Debug("IndexLSH"),Families=new Map;Families.set("EuclideanHashFamily",EuclideanHashFamily_1.default),Families.set("S2JSDHashFamiliy",S2JSDHashFamily_1.default);class IndexLSH{constructor(){const e=Settings_1.default.index();this.enabled=e.enabled;const i=Families.get(e.family),t=e.k,n=e.delta,a=e.w,d="auto"===e.L?Math.ceil(Math.log(1/n)/-Math.log(1-Math.pow(.5,t))):e.L;debug("L: "+d),debug("w: "+a),debug("k: "+t),this.lsh=new LSH_1.default(new i(e.dimensions,a),t,d),this.dao=new IndexDAO_1.default}isEnabled(){return this.enabled}index(e){if(this.enabled&&e&&e.histogram&&null!==e.indexId&&void 0!==e.indexId){const i=new Vector_1.default(e.histogram);this.lsh.index(e.indexId,i)}}indexMany(e){if(this.enabled&&e&&e.length>0){debug("index many...");for(let i=0,t=e.length;i<t;i++)this.index(e[i])}}buildIndex(){return __awaiter(this,void 0,void 0,function*(){this.enabled&&(debug("build index..."),yield this.dao.buildIndex(this))})}query(e){if(this.enabled){debug("query started...");const i=new Vector_1.default(e.histogram);return this.lsh.query(i)}return new Array}}exports.default=IndexLSH;