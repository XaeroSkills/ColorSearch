"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const md5=require("md5"),Debug=require("debug"),ImageFinder_1=require("../core/image-finder/ImageFinder"),ImageInspector_1=require("../core/image-inspector/ImageInspector"),SearchRequest_1=require("../core/SearchRequest"),Settings_1=require("../core/Settings"),debug=Debug("Controller"),config=Settings_1.default.global(),searchConfig=Settings_1.default.searchRequest();class Controller{constructor(e){this.finder=new ImageFinder_1.default(e),this.imageInspector=new ImageInspector_1.default(e),this.auth=md5(`${config.password}`),this.loginRequired=config.loginRequired}find(e,r){const i=e.body.params.colors,t=e.body.params.words,s=e.body.params.settings,o=e.body.params.auth,n=!this.loginRequired||o===this.auth;if(i&&t&&s&&n){let o=0;SearchRequest_1.default.create(i,t,s,searchConfig).then(e=>(o=Date.now(),this.finder.findSimilarImages(e))).then(i=>{debug(`total images found: ${i.length}`);const t=Date.now();debug(`elapsed: ${t-o} ms`),this.succ(e,r,{imgs:i})}).catch(i=>{console.error(i),this.error(e,r)})}else this.error(e,r)}login(e,r){const i=e.body.params.login;this.succ(e,r,{success:i===this.auth})}inspectImageForFailure(e,r){const i=e.body.params.image;i?(debug("inspect image for failure..."),this.imageInspector.imageIsOk(i).then(i=>{debug(`image is faulty: ${!i}`),this.succ(e,r,!i)}).catch(i=>{console.error(i),this.error(e,r)})):this.error(e,r)}isLoginRequired(e,r){this.succ(e,r,{required:this.loginRequired})}error(e,r,i=-3200,t="Server error...",s={}){const o={jsonrpc:"2.0",error:{code:i,message:t,data:s},id:e.body&&void 0!==e.body.id?e.body.id:null};r.writeHead(200,{"content-type":"application/json"}),r.end(JSON.stringify(o))}succ(e,r,i){const t={jsonrpc:"2.0",result:i,id:void 0!==e.body.id?e.body.id:null};r.writeHead(200,{"content-type":"application/json"}),r.end(JSON.stringify(t))}}exports.default=Controller;