"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,r){return new(t||(t=Promise))(function(s,a){function c(e){try{u(r.next(e))}catch(e){a(e)}}function n(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){e.done?s(e.value):new t(function(i){i(e.value)}).then(c,n)}u((r=r.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const EventHub_1=require("../EventHub"),Settings_1=require("../Settings"),ClarifaiService_1=require("./services/ClarifaiService"),Debug=require("debug"),debug=Debug("ImageTagger"),Services=new Map;Services.set("ClarifaiService",new ClarifaiService_1.default);class ImageTagger{constructor(){const e=Settings_1.default.imageTagger();this.sim=e["similarity-threshold"],this.enabled=e.enabled,this.services=e.services.map(e=>{if(Services.has(e))return Services.get(e)}),this.currentService=this.services.length>0?this.services[0]:void 0}tagByPublicURL(e,i){return __awaiter(this,void 0,void 0,function*(){if(this.enabled&&this.currentService){debug("tagging by url...");try{yield this.currentService.tagByPublicURL(e,i,this.sim)}catch(t){yield this.tryOtherServices(e,!0,i)}}})}tagByBase64(e,i){return __awaiter(this,void 0,void 0,function*(){if(this.enabled&&this.currentService){debug("tagging by base64...");try{yield this.currentService.tagByBase64(e,i,this.sim)}catch(t){yield this.tryOtherServices(e,!1,i)}}})}tryOtherServices(e,i,t){return __awaiter(this,void 0,void 0,function*(){let r=0;for(const s of this.services){r++;try{i?yield s.tagByPublicURL(e,t,this.sim):yield s.tagByBase64(e,t,this.sim),this.currentService=s;break}catch(e){if(console.error("ImageTagger service error. Trying another service..."),console.error(e),r===this.services.length){EventHub_1.default.emit("tagging-failed",!0);break}continue}}})}}exports.default=new ImageTagger;