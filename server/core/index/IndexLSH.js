"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))(function(s,n){function d(e){try{l(a.next(e))}catch(e){n(e)}}function r(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(d,r)}l((a=a.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const DAOFactory_1=require("../db-access/DAOFactory"),Chi2HashFamily_1=require("./lsh/families/Chi2HashFamily"),EuclideanHashFamily_1=require("./lsh/families/EuclideanHashFamily"),S2JSDHashFamily_1=require("./lsh/families/S2JSDHashFamily"),LSH_1=require("./lsh/LSH"),Debug=require("debug"),debug=Debug("IndexLSH");class IndexLSH{constructor(e){if(this.lshEnabled=!0===e.lshEnabled,this.dao=DAOFactory_1.DAOFactory.getImagesDAO(),this.exclude=["originId","autotags","license","node"],this.data=new Map,this.max="number"==typeof e.max?e.max:1e4,this.lshEnabled){const t="number"==typeof e.k?e.k:4,i="number"==typeof e.delta?e.delta:.1,a="number"==typeof e.w?e.w:.4,s="number"==typeof e.p?e.p:.5,n="number"==typeof e.dimensions?e.dimensions:0,d=e.L&&"number"==typeof e.L?e.L:Math.ceil(Math.log(1/i)/-Math.log(1-Math.pow(s,t)));debug(`L: ${d}, w: ${a}, k: ${t}`);"string"==typeof e.family&&e.family.toLowerCase();switch(e.family){case"chi2":this.lsh=new LSH_1.default(new Chi2HashFamily_1.default(n,a),t,d);break;case"s2jsd":this.lsh=new LSH_1.default(new S2JSDHashFamily_1.default(n,a),t,d);break;default:this.lsh=new LSH_1.default(new EuclideanHashFamily_1.default(n,a),t,d)}}}index(e){this.data.has(e.id)||(this.exclude.forEach(t=>delete e[t]),this.data.set(e.id,e),this.lshEnabled&&this.lsh.index(e.id,e.histogram))}indexMany(e){if(e&&e.length>0){debug("index many...");for(let t=0,i=e.length;t<i;t++)this.index(e[t])}}query(e,t){return __awaiter(this,void 0,void 0,function*(){if(debug("query started..."),this.lshEnabled){const i=e.getRequestDescriptor(),a=[],s=yield this.lsh.query(i.histogram);return debug(`candidates: ${s.length}`),new Promise((i,n)=>{let d=s.length;const r=()=>{let n=1e3;for(;n--;){if(!(d-- >=0&&a.length<t))return void i(a);{const t=this.data.get(s[d]);t&&e.compare(t,a)}}setImmediate(r)};setImmediate(r)})}return this.linearQuery(e,t)})}linearQuery(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,a)=>{const s=[],n=this.data.values(),d=()=>{let a=1e3;for(;a--;){const a=n.next();if(a.done||!(s.length<t))return void i(s);{const t=a.value;t&&e.compare(t,s)}}setImmediate(d)};setImmediate(d)})})}remove(e){const t="number"==typeof e?e:e.id;this.data.has(t)&&(this.data.delete(t),this.lshEnabled&&this.lsh.remove(t))}load(){return __awaiter(this,void 0,void 0,function*(){debug("build index..."),yield this.dao.iterateNode(e=>{this.index(e)},this.max),debug(`indexed: ${this.data.size} elements...`),console.log(`${(new Date).toString()} indexed: ${this.data.size} elements...`)})}count(){return this.data.size}}exports.default=IndexLSH;