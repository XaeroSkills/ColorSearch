"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,a){return new(t||(t=Promise))(function(n,o){function s(e){try{c(a.next(e))}catch(e){o(e)}}function i(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new t(function(r){r(e.value)}).then(s,i)}c((a=a.apply(e,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const Debug=require("debug"),debug=Debug("ImageSaver"),ImageDTO_js_1=require("../dto/ImageDTO.js"),EventHub_1=require("../EventHub"),ImageDescriptor_1=require("../image-descriptor/ImageDescriptor"),ImageSaverDAO_1=require("./dao/ImageSaverDAO");class ImageSaver{constructor(e){this.sources=Array.isArray(e)?e:new Array,this.dao=new ImageSaverDAO_1.default}saveNext(){return __awaiter(this,void 0,void 0,function*(){const e=this.sources.map(e=>e.read());if(!e||e.length<1)return console.warn("No sources found"),new Promise(e=>e());let r=new Array;try{r=yield Promise.all(e)}catch(e){console.error(e)}let t=new Array;r.forEach(e=>{e&&e.length>0&&(t=t.concat(e))}),t=t.filter(e=>e instanceof ImageDTO_js_1.default);const a=yield ImageDescriptor_1.default.createMany(t);try{yield this.dao.saveDescriptors(a)}catch(e){console.error(e)}t=null,EventHub_1.default.emit("saved",!0),debug("saved")})}}exports.default=ImageSaver;