"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),ImageDTO_js_1=require("../../../dto/ImageDTO.js"),Flickr=require("node-flickr"),md5=require("md5"),keys={api_key:"07d4e8fe2bf1734aef943caa250b67f9"},flickr=new Flickr(keys),Settings_1=require("../../../Settings"),Debug=require("debug"),debug=Debug("FlickrSource");class FlickrSource{constructor(t){const e=Settings_1.default.flickrSource();this.enabled=e.enabled,this.step=e.step,this.wordLists=e["word-lists"],this.wordListsPath=__dirname+"/word-lists",this.randomization=e.randomization,this.sourceName="flickr",this.apiMethod="photos.getRecent",this.imgsParser=new FlickrPhotoParser,this.options=t||{extras:"url_m, url_t, tags",license:"4,5,6,7",media:"photos",page:20,per_page:this.step,text:""}}read(){return new Promise((t,e)=>{debug("flickr get image data...");let s=new Array;this.enabled?(this.setupFlickrSearch(),console.warn("SELECTED WORD: "+this.options.text),flickr.get(this.apiMethod,this.options,(r,i)=>{if(r||"ok"!==i.stat)e(r);else{const e=this.imgsParser.parseImages(i);s=e.map(t=>{const e=new ImageDTO_js_1.default;return e.id=md5(t.id)+this.sourceName,e.url=t.url,e.originalURL="http://flickr.com/photo.gne?id="+t.id,e.text=t.tags+" "+t.title,e.source=this.sourceName,e}),t(s)}})):t(s)})}setupFlickrSearch(){if(this.options.text="",this.apiMethod="photos.getRecent",this.options.page=Math.round(1e3*Math.random()),this.wordLists.length>0&&Math.random()>=this.randomization){const t=Math.round(Math.random()*(this.wordLists.length-1)),e=this.wordLists[t];try{const t=fs.readFileSync(this.wordListsPath+"/"+e,"utf8").split("\n"),s=Math.round(Math.random()*(t.length-1));this.options.text=t[s],this.apiMethod="photos.search"}catch(t){console.error(t)}}}}exports.default=FlickrSource;class FlickrPhotoParser{parseImages(t){const e=[];if("ok"===t.stat){const s=t.photos.photo;for(let t=0;t<s.length;t++)if(s[t].ispublic){const r=this.getImageData(s[t]);e.push(r)}}else console.error(t.message+". Error code: "+t.code);return e}getImageData(t){const e={};e.title=t.title,e.tags=t.tags,e.id=t.id;const s=t.originalformat?t.originalformat:"jpg";return e.url="https://farm"+t.farm+".staticflickr.com/"+t.server+"/"+t.id+"_"+t.secret+"."+s,e}}