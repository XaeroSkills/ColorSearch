"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,c){function r(e){try{l(i.next(e))}catch(e){c(e)}}function d(e){try{l(i.throw(e))}catch(e){c(e)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,d)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const EventHub_1=require("../../EventHub"),Settings_1=require("../../Settings"),Debug=require("debug"),debug=Debug("ImageSaverDAO"),config=Settings_1.default.global();class ImageSaverDAO{saveDescriptors(e){return __awaiter(this,void 0,void 0,function*(){if(e&&e.length>0){debug("saving...");try{const t=yield Settings_1.default.dbConnection();if(!t)return Promise.reject(new Error("No db connection."));yield t.collection(config.dbCollection).createIndex({indexId:1}),yield t.collection(config.dbCollection).createIndex({id:1},{unique:!0});const n=yield t.collection(config.dbCollection).find({},{fields:{indexId:1}}).sort({indexId:-1}).limit(1).toArray();let i=n&&n.length>0?++n[0].indexId:0;e.forEach(e=>e.indexId=i++);const o=e.map(e=>e.toJSON()),c=yield t.collection(config.dbCollection).insertMany(o,{ordered:!1});EventHub_1.default.emit("images-saved",c.ops),debug("saving successful")}catch(e){console.error(e)}}})}}exports.default=ImageSaverDAO;