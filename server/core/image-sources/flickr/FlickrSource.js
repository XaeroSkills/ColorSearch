"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(s,o){function a(t){try{c(i.next(t))}catch(t){o(t)}}function n(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?s(t.value):new r(function(e){e(t.value)}).then(a,n)}c((i=i.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),TextUtil_1=require("../../common/TextUtil"),ImageDTO_js_1=require("../../dto/ImageDTO.js"),ImageSource_1=require("../ImageSource"),Debug=require("debug"),debug=Debug("FlickrSource"),Flickr_1=require("./flickr-api/Flickr"),flickr=new Flickr_1.default("07d4e8fe2bf1734aef943caa250b67f9");class FlickrSource extends ImageSource_1.default{constructor(t){super(),this.enabled=!0===t.enabled;const e="number"==typeof t.step?t.step:5;this.wordLists=Array.isArray(t.wordLists)?t.wordLists:[],this.wordListsPath=__dirname+"/word-lists",this.randomization="number"==typeof t.randomization?t.randomization:.5,this.sourceName="flickr",this.apiMethod="",this.imgsReader=new FlickrPhotoReader,this.options={extras:"tags,owner_name,license",license:"1,2,3,4,5,6,9,10,4",media:"photos",page:20,per_page:e,text:"",privacy_filter:1,safe_search:1,content_type:1}}getData(){return __awaiter(this,void 0,void 0,function*(){let t=new Array;if(this.enabled){debug("flickr get image data..."),this.setupFlickrSearch(),console.log(`${(new Date).toString()} selected word: ${this.options.text}`);try{const e=yield flickr.get(this.apiMethod,this.options);if(e&&"ok"===e.stat){t=this.imgsReader.read(e).map(t=>{const e=new ImageDTO_js_1.default;return e.id=t.id,e.url=t.url,e.previewURL=t.smallURL,e.originalURL="http://flickr.com/photo.gne?id="+t.id,e.tags=TextUtil_1.default.cleanTextFromHtml(t.tags),e.source=this.sourceName,e.owner=t.owner,e.license=t.license,e.title=TextUtil_1.default.cleanTextFromHtml(t.title),e})}}catch(t){console.error(t)}}return t})}setupFlickrSearch(){if(this.options.text="",this.apiMethod="photos.getRecent",this.options.page=Math.round(1e3*Math.random()),this.wordLists.length>0&&Math.random()>=this.randomization){const t=Math.round(Math.random()*(this.wordLists.length-1)),e=this.wordLists[t];try{const t=fs.readFileSync(this.wordListsPath+"/"+e,"utf8").split("\n"),r=Math.round(Math.random()*(t.length-1));this.options.text=t[r].trim(),this.apiMethod="photos.search"}catch(t){console.error(t)}}}}exports.default=FlickrSource;class FlickrPhotoReader{read(t){const e=[];if("ok"===t.stat){const r=t.photos.photo;for(let t=0;t<r.length;t++)if(r[t].ispublic){const i=this.getImageData(r[t]);e.push(i)}}else console.error(t.message+". Error code: "+t.code);return e}getImageData(t){const e={};e.title=t.title,e.tags=t.tags,e.id=t.id;const r="https://farm"+t.farm+".staticflickr.com/"+t.server+"/"+t.id+"_"+t.secret;return e.url=r+"_b.jpg",e.smallURL=r+"_n.jpg",e.owner=t.ownername,e.license=t.license,e}}