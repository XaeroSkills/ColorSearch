"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))(function(a,i){function n(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(n,o)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const TextUtil_1=require("../common/TextUtil"),ImageDTO_1=require("../dto/ImageDTO"),Debug=require("debug"),path=require("path"),fs=require("fs"),md5=require("md5"),ImageSource_1=require("./ImageSource"),debug=Debug("LocalSource");class LocalSource extends ImageSource_1.default{constructor(e){super(),this.sourceName="local",this.enabled=!0===e.enabled,this.step="number"==typeof e.step?e.step:5,this.path=e.path||"imgs",this.imgsPath=e.publicPath,this.exts=[".jpg",".jpeg",".gif"]}getData(){return __awaiter(this,void 0,void 0,function*(){const e=new Array;if(this.enabled){let t=new Array;try{t=fs.readdirSync(this.path)}catch(e){console.error(e)}if(t&&t.length>0){t=t.filter(e=>{try{return fs.accessSync(this.path+"/"+e,fs.constants.R_OK|fs.constants.W_OK),fs.lstatSync(this.path+"/"+e).isFile()}catch(e){return!1}});try{yield this.getImagesData(t,e)}catch(e){console.error(e)}}}return e})}getImagesData(e,t){return __awaiter(this,void 0,void 0,function*(){const r=e.slice(0,this.step),s=/.+(?=\..+)/i;for(const e of r)if(this.exts.includes(path.extname(e))){const r=new ImageDTO_1.default,a=s.exec(e)[0],i=TextUtil_1.default.cleanTextFromHtml(a);r.base64=fs.readFileSync(this.path+"/"+e,{encoding:"base64"}),r.id=md5(r.base64),r.tags=i,r.source=this.sourceName,r.url=r.id+path.extname(e),r.previewURL=r.url,r.originalURL=r.url,r.owner="unknown",r.license="unknown",r.title=i;try{debug("move file to folder..."),fs.renameSync(this.path+"/"+e,this.imgsPath+"/"+r.url)}catch(e){console.error(e);continue}t.push(r)}})}}exports.default=LocalSource;