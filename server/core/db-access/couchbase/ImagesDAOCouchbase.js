"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,s){function r(e){try{u(o.next(e))}catch(e){s(e)}}function c(e){try{u(o.throw(e))}catch(e){s(e)}}function u(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(r,c)}u((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const Descriptors_1=require("../../descriptors/Descriptors"),Settings_1=require("../../Settings"),Debug=require("debug"),couchbase=require("couchbase"),debug=Debug("ImagesDAOCouchbase");class ImagesDAOCouchbase{constructor(){this.db=Settings_1.default.db(),this.nodeId=Settings_1.default.global().id,this.amountQuery=couchbase.N1qlQuery.fromString(`SELECT COUNT(*) as count from images WHERE node = ${this.nodeId}`)}delete(e){return __awaiter(this,void 0,void 0,function*(){const t=yield this.db.connection("images"),i=couchbase.N1qlQuery.fromString(`DELETE FROM images USE KEYS '${e}'`);return yield new Promise((e,o)=>{t.query(i,{},(t,i)=>{t&&console.log(t),e()})})})}saveMany(e){return __awaiter(this,void 0,void 0,function*(){const t=new Array,i=yield this.db.connection("images");return yield new Promise((o,n)=>{const s=()=>{if(e&&e.length>0){const o=e.pop();i.insert(`${o.id}`,o,(e,i)=>{e?debug(e):t.push(o),s()})}else o()};s()}),t})}countForNode(){return __awaiter(this,void 0,void 0,function*(){const e=yield this.db.connection("images");return yield new Promise((t,i)=>{e.query(this.amountQuery,{},(e,i)=>{e?(console.log(e),t(0)):t(i&&isNaN(i[0].count)?0:Number.parseInt(i[0].count))})})})}iterateNode(e,t=1/0){return __awaiter(this,void 0,void 0,function*(){let i=0,o=0;const n=yield this.db.connection("images");yield new Promise((s,r)=>{const c=()=>{if(i<t){const r=couchbase.N1qlQuery.fromString(`SELECT images.* FROM images WHERE node = ${this.nodeId} LIMIT 1000 OFFSET ${o}`);n.query(r,{},(n,r)=>{if(o+=1e3,n)console.log(n),s();else if(r&&r.length>0){let o=r.length;for(;o--&&i<t;)e(new Descriptors_1.ImageDescriptor(r[o])),i++;c()}else s()})}else s()};c()})})}}exports.default=ImagesDAOCouchbase;