"use strict";var __awaiter=this&&this.__awaiter||function(r,e,t,i){return new(t||(t=Promise))(function(o,s){function a(r){try{n(i.next(r))}catch(r){s(r)}}function c(r){try{n(i.throw(r))}catch(r){s(r)}}function n(r){r.done?o(r.value):new t(function(e){e(r.value)}).then(a,c)}n((i=i.apply(r,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const TextUtil_1=require("../common/TextUtil"),Vector_1=require("../common/Vector"),HSVHistogram_1=require("../histogram/hsv/HSVHistogram"),Settings_1=require("../Settings"),Descriptors_1=require("./Descriptors");exports.Descriptor=Descriptors_1.Descriptor,exports.ImageDescriptor=Descriptors_1.ImageDescriptor;const Colr=require("colr"),Debug=require("debug"),Jimp=require("jimp"),shajs=require("sha.js"),hexToBinary=require("hex-to-binary"),debug=Debug("ImageDescriptorBuilder"),config=Settings_1.default.global();class DescriptorBuilder{static createMany(r){return __awaiter(this,void 0,void 0,function*(){const e=new Array;debug("creating descriptors...");for(const t of r)try{const r=yield DescriptorBuilder.create(t);r&&e.push(r)}catch(r){console.error(r);continue}return e})}static createFromQuery(r,e){return __awaiter(this,void 0,void 0,function*(){const e=new Descriptors_1.ImageDescriptor,t=DescriptorBuilder.histogramFactory.createHistogram();for(const e of r)try{for(let r=0;r<e.weight;r++){const r=Colr.fromHslObject(e).toHsvObject();t.addColor(r)}}catch(r){return console.error(r),null}return t.done(),e.histogram=new Vector_1.default(t.toArray()),e})}static create(r){return __awaiter(this,void 0,void 0,function*(){const e=new Descriptors_1.ImageDescriptor;debug("create descriptor...");const t="local"===r.source?`${config.imgsPath}/${r.url}`:r.url;try{yield DescriptorBuilder.createImageHistogram(t,r,e)}catch(r){return console.error(r),null}return e.originId=r.id,e.source=r.source,e.previewURL=r.previewURL,e.originalURL=r.originalURL,e.url=r.url,e.owner=TextUtil_1.default.truncate(TextUtil_1.default.clean(r.owner),DescriptorBuilder.MAX_OWNER_LENGTH),e.title=TextUtil_1.default.truncate(TextUtil_1.default.clean(r.title),DescriptorBuilder.MAX_TITLE_LENGTH),e.license=r.license,e})}static createImageHistogram(r,e,t){return __awaiter(this,void 0,void 0,function*(){const e=DescriptorBuilder.histogramFactory.createHistogram();return debug("creating histogram..."),Jimp.read(r).then(r=>{debug(`original size: ${r.bitmap.width} X ${r.bitmap.height}`),r.bitmap.width>DescriptorBuilder.MAX_IMAGE_WIDTH&&r.resize(DescriptorBuilder.MAX_IMAGE_WIDTH,Jimp.AUTO),r.bitmap.height>DescriptorBuilder.MAX_IMAGE_HEIGHT&&r.resize(Jimp.AUTO,DescriptorBuilder.MAX_IMAGE_HEIGHT),r.blur(2),debug(`size for histogram: ${r.bitmap.width} X ${r.bitmap.height}`),debug("read..."),r.scan(0,0,r.bitmap.width,r.bitmap.height,(t,i,o)=>{const s={r:r.bitmap.data[o+0],g:r.bitmap.data[o+1],b:r.bitmap.data[o+2]},a=Colr.fromRgbObject(s).toHsvObject();e.addColor(a)}),e.done(),t.histogram=new Vector_1.default(e.toArray());const i=r.bitmap.data.toString("base64"),o=shajs("sha1").update(i).digest("hex"),s=hexToBinary(o);t.id=Number.parseInt(s.substr(0,53),2),debug(`descriptor id: ${t.id}`)})})}}DescriptorBuilder.MAX_TITLE_LENGTH=50,DescriptorBuilder.MAX_OWNER_LENGTH=30,DescriptorBuilder.MAX_IMAGE_WIDTH=150,DescriptorBuilder.MAX_IMAGE_HEIGHT=150,DescriptorBuilder.histogramFactory=new HSVHistogram_1.default,exports.DescriptorBuilder=DescriptorBuilder;